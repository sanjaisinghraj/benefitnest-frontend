# Portal Feature - Code Examples & Customization

## How to Customize the Portal Template

### Change the Portal Design

The portal HTML is generated by the `generatePortalHTML()` function in `backend/routes/portal.routes.js`.

### Example: Add Employee Login Form

Replace the "Coming Soon" section with a login form:

```javascript
// In generatePortalHTML(), replace this line:
// <div class="badge">‚ö†Ô∏è Portal Under Development - Coming Soon!</div>

// With this:
const loginForm = `
  <form id="loginForm" style="text-align: left; margin: 24px 0;">
    <input type="text" placeholder="Employee ID" style="width: 100%; padding: 12px; 
           margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 8px;">
    <input type="password" placeholder="Password" style="width: 100%; padding: 12px; 
           margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 8px;">
    <button type="submit" class="btn" style="width: 100%;">Login</button>
  </form>
`;
```

### Example: Add Custom Content Sections

Add a benefits overview:

```javascript
const benefitsSection = `
  <div style="margin: 32px 0; text-align: left;">
    <h2 style="font-size: 20px; color: #111827; margin-bottom: 16px;">Your Benefits</h2>
    <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
      <div style="margin-bottom: 16px;">
        <h3 style="color: #4b5563; margin-bottom: 8px;">üìã Health Insurance</h3>
        <p style="color: #6b7280; font-size: 14px;">Comprehensive coverage for you and your family</p>
      </div>
      <div style="margin-bottom: 16px;">
        <h3 style="color: #4b5563; margin-bottom: 8px;">üí∞ Retirement Plan</h3>
        <p style="color: #6b7280; font-size: 14px;">Secure your future with our pension scheme</p>
      </div>
    </div>
  </div>
`;
```

### Example: Fetch Data from Backend

Make the portal dynamic by fetching company data:

```javascript
// Update the portal HTML return to include script:
// Add this before </body>:

<script>
  // Fetch company data
  fetch('/api/portal/tenant/${subdomain}')
    .then(r => r.json())
    .then(data => {
      if (data.success && data.data.logo_url) {
        // Update logo dynamically
        document.querySelector('.logo img').src = data.data.logo_url;
      }
    })
    .catch(e => console.error('Failed to load company data:', e));
</script>
```

---

## How to Add Employee Features

### 1. Add Login Endpoint

The login endpoint already exists in `portal.routes.js`:

```javascript
POST /api/portal/login
Body:
{
  "tenant_id": "560aa04b-d137-4e32-898c-0d611fda0c24",
  "employee_id": "EMP001",
  "password": "demo123"
}

Response:
{
  "success": true,
  "token": "eyJhbGc...",
  "user": {
    "employee_id": "EMP001",
    "first_name": "John",
    "last_name": "Doe",
    "email": "john@company.com"
  }
}
```

### 2. Create Employee Dashboard Page

Create `frontend/app/portal/[subdomain]/dashboard/page.tsx`:

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';

export default function EmployeeDashboard() {
  const [employee, setEmployee] = useState(null);
  const [loading, setLoading] = useState(true);
  const router = useRouter();

  useEffect(() => {
    const token = localStorage.getItem('portal_token');
    
    if (!token) {
      router.push('/portal/login');
      return;
    }

    // Verify token
    fetch('/api/portal/verify-token', {
      headers: { 'Authorization': `Bearer ${token}` }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        setEmployee(data.user);
      } else {
        localStorage.removeItem('portal_token');
        router.push('/portal/login');
      }
    })
    .finally(() => setLoading(false));
  }, []);

  if (loading) return <div>Loading...</div>;
  if (!employee) return null;

  return (
    <div>
      <h1>Welcome, {employee.first_name}!</h1>
      <p>Email: {employee.email}</p>
      <p>Department: {employee.department}</p>
      
      <h2>Your Benefits</h2>
      <ul>
        <li>Health Insurance</li>
        <li>Retirement Plan</li>
        <li>Life Insurance</li>
      </ul>
    </div>
  );
}
```

### 3. Update Portal to Include Login

Modify `generatePortalHTML()` in `backend/routes/portal.routes.js`:

```javascript
// Add login button
const loginButton = `
  <a href="/portal?tenant=${tenant_id}" style="
    display: inline-block;
    background: ${primaryColor};
    color: white;
    padding: 12px 32px;
    border-radius: 8px;
    text-decoration: none;
    margin-top: 16px;
  ">Employee Login</a>
`;
```

---

## Database Schema

### Add Portal Tracking to Tenants Table

Already added columns:
```sql
ALTER TABLE tenants ADD COLUMN portal_created_at TIMESTAMP DEFAULT NULL;
ALTER TABLE tenants ADD COLUMN portal_file VARCHAR(255) DEFAULT NULL;
```

### Activity Logging

Portal creation is logged to `corporate_activity_log`:

```javascript
{
  tenant_id: "560aa04b-d137-4e32-898c-0d611fda0c24",
  activity_type: "PORTAL_CREATED",
  description: "Portal created for subdomain: kind",
  entity_type: "PORTAL",
  entity_id: "kind.html",
  created_at: "2025-12-27T12:00:00Z"
}
```

---

## Advanced Features

### 1. Rate Limiting Portal Creation

Add to `backend/routes/portal.routes.js`:

```javascript
const rateLimit = require('express-rate-limit');

const portalLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 hour
  max: 5, // 5 requests per hour
  message: 'Too many portal creation attempts, please try later'
});

router.post(
  '/admin/corporates/:tenantId/create-portal',
  portalLimiter,
  createPortalHandler
);
```

### 2. Validate Portal HTML Before Saving

```javascript
const isValidHTML = (html) => {
  if (!html || typeof html !== 'string') return false;
  if (html.length > 1024 * 1024) return false; // Max 1MB
  return html.includes('<!DOCTYPE html>') || html.includes('<html');
};

if (!isValidHTML(portalHTML)) {
  throw new Error('Invalid HTML generated');
}
```

### 3. Backup Portal Before Update

```javascript
// Before overwriting existing portal
if (fs.existsSync(portalPath)) {
  const backupPath = portalPath.replace('.html', `.backup.${Date.now()}.html`);
  fs.copyFileSync(portalPath, backupPath);
}
```

---

## API Testing

### Test Check Portal

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://benefitnest-backend.onrender.com/api/admin/corporates/560aa04b-d137-4e32-898c-0d611fda0c24/check-portal
```

### Test Create Portal

```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  https://benefitnest-backend.onrender.com/api/admin/corporates/560aa04b-d137-4e32-898c-0d611fda0c24/create-portal
```

### Test Verify Portal File Created

```bash
curl https://benefitnest-backend.onrender.com/api/portal/tenant/kind
```

---

## Monitoring

### Check Portal Creation Logs

```bash
# Watch for portal creation in real-time
tail -f /var/log/benefitnest/backend.log | grep PORTAL

# Or via Docker
docker logs benefitnest-backend | grep PORTAL
```

### Monitor File System

```bash
# Check portal files
ls -lah backend/portals/

# Check file sizes
du -sh backend/portals/

# Count portals
ls backend/portals/ | wc -l
```

---

## Troubleshooting Code

If portals aren't being created, add debug logging:

```javascript
// In create-portal endpoint
console.log(`[DEBUG] Creating portal for tenant: ${tenantId}`);
console.log(`[DEBUG] Corporate data:`, corporate);
console.log(`[DEBUG] Portal path: ${portalPath}`);
console.log(`[DEBUG] HTML size: ${portalHTML.length} bytes`);
console.log(`[DEBUG] Writing to: ${portalPath}`);

try {
  fs.writeFileSync(portalPath, portalHTML, 'utf8');
  console.log(`[DEBUG] File written successfully`);
} catch (err) {
  console.error(`[DEBUG] Write failed:`, err.message, err.code);
  throw err;
}
```

---

**Last Updated:** December 27, 2025
